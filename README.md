# –°–∏—Å—Ç–µ–º–∞ JWT —Å IP-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ –∏ Refresh Tokens

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏, –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ IP-–∞–¥—Ä–µ—Å–∞–º, refresh tokens –∏ SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ Access –∏ Refresh —Ç–æ–∫–µ–Ω—ã
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ IP-–∞–¥—Ä–µ—Å—É –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ SQLite –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ wildcard –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `192.168.1.*`)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ IP —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
- ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —Å bcrypt
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
npm install
```

## –ó–∞–ø—É—Å–∫

```bash
npm start
```

–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π:
```bash
npm run dev
```

## API Endpoints

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```bash
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω",
  "user": {
    "id": 1,
    "username": "testuser"
  }
}
```

### 2. –í—Ö–æ–¥
```bash
POST /api/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "message": "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ",
  "accessToken": "eyJhbGc...",
  "refreshToken": "eyJhbGc...",
  "expiresIn": 900,
  "tokenType": "Bearer",
  "user": {
    "id": 1,
    "username": "testuser"
  },
  "ip": "127.0.0.1",
  "allowedIps": ["127.0.0.1"]
}
```

### 3. –í—Ö–æ–¥ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ IP
```bash
POST /api/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123",
  "allowedIps": ["192.168.1.*", "10.0.0.5"]
}
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
```bash
POST /api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "eyJhbGc..."
}
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "message": "–¢–æ–∫–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã",
  "accessToken": "eyJhbGc...",
  "refreshToken": "eyJhbGc...",
  "expiresIn": 900,
  "tokenType": "Bearer"
}
```

### 5. –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
```bash
GET /api/protected
Authorization: Bearer <accessToken>
```

### 6. –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
GET /api/profile
Authorization: Bearer <accessToken>
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "profile": {
    "id": 1,
    "username": "testuser",
    "createdAt": "2024-01-01 12:00:00",
    "currentIp": "127.0.0.1",
    "allowedIps": ["127.0.0.1"],
    "activeSessions": 1
  },
  "sessions": [
    {
      "id": 1,
      "ip_address": "127.0.0.1",
      "allowed_ips": ["127.0.0.1"],
      "expires_at": "2024-01-01 12:15:00",
      "created_at": "2024-01-01 12:00:00"
    }
  ]
}
```

### 7. –í—ã—Ö–æ–¥
```bash
POST /api/auth/logout
Authorization: Bearer <accessToken>
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
```bash
# 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}'

# 2. –í—Ö–æ–¥
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}'

# 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ access token
curl http://localhost:3000/api/protected \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
curl -X POST http://localhost:3000/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refreshToken":"YOUR_REFRESH_TOKEN"}'

# 5. –í—ã—Ö–æ–¥
curl -X POST http://localhost:3000/api/auth/logout \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îî‚îÄ‚îÄ jwtService.js       # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ database.js         # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SQLite
‚îÇ   ‚îú‚îÄ‚îÄ userRepository.js   # –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ tokenRepository.js  # –†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ authMiddleware.js   # Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ ipUtils.js          # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å IP
‚îú‚îÄ‚îÄ server.js               # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ .env                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ package.json
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –ü–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é bcrypt (10 —Ä–∞—É–Ω–¥–æ–≤)
- ‚úÖ Access —Ç–æ–∫–µ–Ω—ã –∂–∏–≤—É—Ç 15 –º–∏–Ω—É—Ç
- ‚úÖ Refresh —Ç–æ–∫–µ–Ω—ã –∂–∏–≤—É—Ç 7 –¥–Ω–µ–π
- ‚úÖ –¢–æ–∫–µ–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç IP-–∞–¥—Ä–µ—Å –≤ payload
- ‚úÖ –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ IP
- ‚úÖ –í—Å–µ —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ —Å—Ç–∞—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (X-Forwarded-For, X-Real-IP)
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:
```
JWT_SECRET=your-secret-key-here
REFRESH_SECRET=your-refresh-secret-key-here
PORT=3000
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite —Å –¥–≤—É–º—è —Ç–∞–±–ª–∏—Ü–∞–º–∏:

### –¢–∞–±–ª–∏—Ü–∞ users
- id (PRIMARY KEY)
- username (UNIQUE)
- password_hash
- created_at
- updated_at

### –¢–∞–±–ª–∏—Ü–∞ tokens
- id (PRIMARY KEY)
- user_id (FOREIGN KEY)
- access_token (UNIQUE)
- refresh_token (UNIQUE)
- ip_address
- allowed_ips (JSON)
- expires_at
- refresh_expires_at
- is_revoked
- created_at

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏

1. **–ü—Ä–∏ –≤—Ö–æ–¥–µ**: —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –ø–∞—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤, –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è
2. **–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏**: —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –ø–∞—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤, —Å—Ç–∞—Ä–∞—è –ø–∞—Ä–∞ –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è
3. **–ü—Ä–∏ –≤—ã—Ö–æ–¥–µ**: –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è
4. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –∫–∞–∂–¥—ã–π —á–∞—Å —É–¥–∞–ª—è—é—Ç—Å—è –∏—Å—Ç–µ–∫—à–∏–µ refresh —Ç–æ–∫–µ–Ω—ã

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Postman
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `postman_collection.json` –≤ Postman –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ —Ñ–∞–π–ª–µ `POSTMAN_GUIDE.md`.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å –æ–¥–Ω–∏–º IP
- ‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å –¥—Ä—É–≥–æ–≥–æ IP (—Å–∏–º—É–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ X-Forwarded-For)
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å wildcard –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ (192.168.1.*)
- üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö
- üö™ –í—ã—Ö–æ–¥ –∏ –ø–æ–ª–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤

### REST Client (VS Code)
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª `test-requests.http` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API endpoints –≤ VS Code —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º REST Client.
